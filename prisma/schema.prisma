// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String?  @unique  // 改为可选
  name      String?
  avatarUrl String?  @map("avatar_url")
  githubId  String?  @unique @map("github_id")
  giteeId   String?  @unique @map("gitee_id")  // 新增这行
  provider  String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // 关联
  studyRecords StudyRecord[]
  studyPlans StudyPlan[]
  createdProblems LeetCodeProblem[] @relation("CreatedProblems")
  userCategories UserCategory[]

  @@map("users")
}

model UserCategory {
  id        String        @id @default(cuid())
  userId    String        @map("user_id")
  name      String
  createdAt DateTime      @default(now()) @map("created_at")

  // 关联
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  studyRecords  StudyRecord[]

  @@unique([userId, name])
  @@map("user_categories")
}

model StudyRecord {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  problemId   String    @map("problem_id")
  studyPlanId String?   @map("study_plan_id") // 关联到具体的学习计划
  completedAt DateTime? @map("completed_at")
  difficulty  String    @default("medium")
  timeSpent   Int       @default(0) @map("time_spent") // 分钟
  reviewCount Int       @default(0) @map("review_count")
  createdAt   DateTime  @default(now()) @map("created_at")
  completed   Boolean   @default(false)
  notes       String?   @default("")
  lastReviewDate DateTime? @map("last_review_date")
  firstStudyDate DateTime @default(now()) @map("first_study_date") // 首次学习日期
  categoryId  String?   @map("category_id") // 用户自定义分类ID
  
  // 关联
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  leetcodeProblem LeetCodeProblem @relation(fields: [problemId], references: [id], onDelete: Cascade)
  studyPlan       StudyPlan?   @relation(fields: [studyPlanId], references: [id], onDelete: SetNull)
  userCategory    UserCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@unique([userId, problemId]) // 确保每个用户每道题只有一条记录
  @@map("study_records")
}

model StudyPlan {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  status          String   @default("active") // active/destroyed/completed
  startDate       DateTime @map("start_date")
  intensity       String   @default("medium")
  duration        Int      @default(30) // 计划天数
  name            String    // 添加这一行
  // 计划核心数据
  planProblems    String[] @map("plan_problems")    // 计划要学的所有题目ID
  learnedProblems String[] @map("learned_problems") // 已学会的题目ID

  // 积压管理
  pendingTasks    Int      @default(0) @map("pending_tasks")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // 关联
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  dailyTasks      DailyTask[]
  studyRecords    StudyRecord[] // 添加反向关联

  @@map("study_plans")
}

model DailyTask {
  id             String   @id @default(cuid())
  planId         String   @map("plan_id")
  day            Int      // 第几天
  originalDate   DateTime @map("original_date")   // 原计划日期
  currentDate    DateTime @map("current_date")    // 当前应完成日期

  status         String   @default("pending") // pending/completed
  completedAt    DateTime? @map("completed_at")

  createdAt      DateTime @default(now()) @map("created_at")

  // 关联
  plan           StudyPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  taskItems      TaskItem[]

  @@map("daily_tasks")
}

model TaskItem {
  id          String    @id @default(cuid())
  dailyTaskId String    @map("daily_task_id")
  problemId   String    @map("problem_id")
  taskType    String    // "new" or "review"
  completed   Boolean   @default(false) // 核心！只表示当日是否完成

  // 关联
  dailyTask   DailyTask @relation(fields: [dailyTaskId], references: [id], onDelete: Cascade)
  problem     LeetCodeProblem @relation(fields: [problemId], references: [id])
  
  @@index([dailyTaskId])
  @@map("task_items")
}

model LeetCodeProblem {
  id          String   @id @default(cuid())
  slug        String   @unique  // 题目slug，如 "two-sum"，作为唯一标识
  number      Int?     // LeetCode题号，可为空
  title       String   // 题目标题
  titleCn     String?  // 中文标题
  difficulty  String   // easy/medium/hard
  url         String   // LeetCode链接
  tags        String[] // 标签数组
  category    String?  // 分类（如：数组、链表等）
  
  // 扩展字段：支持用户自定义题目
  isPublic    Boolean  @default(true)  // true=公共题目，false=私有题目
  createdBy   String?  @map("created_by") // 创建者ID，公共题目为null
  notes       String   @default("")     // 用户笔记
  
  createdAt   DateTime @default(now()) @map("created_at")

  // 关联
  studyRecords StudyRecord[]
  taskItems   TaskItem[]
  creator     User? @relation("CreatedProblems", fields: [createdBy], references: [id])

  @@map("leetcode_problems")
}
